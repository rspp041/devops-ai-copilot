name: AI - Generate Tests

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-tests:
    if: ${{ github.event.issue.pull_request != null && startsWith(github.event.comment.body, '/generate-tests') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r tools/requirements-ci.txt
          pip install -r apps/sample-service/requirements.txt

      - name: Fetch PR branch and checkout
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL="${{ github.event.issue.pull_request.url }}"
          HEAD_REF=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$PR_URL" | python -c "import sys,json; print(json.load(sys.stdin)['head']['ref'])")
          git fetch origin "$HEAD_REF"
          git checkout "$HEAD_REF"

      - name: Build diff vs main
        run: |
          git fetch origin main
          git diff origin/main...HEAD > /tmp/pr.diff
          wc -l /tmp/pr.diff

      - name: Generate tests via OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
          LLM_PROVIDER: openai
        run: |
          python -m ai.generate_tests \
            --diff /tmp/pr.diff \
            --repo-root . \
            --service apps/sample-service \
            --out-dir /tmp/ai-tests

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q

      - name: Commit generated tests back to PR branch
        run: |
          git config user.name "devops-ai-copilot"
          git config user.email "actions@users.noreply.github.com"
          git add apps/sample-service/tests/test_generated_ai.py apps/sample-service/AI_TEST_REPORT.md || true
          git commit -m "chore(ai): add generated tests" || echo "No changes to commit"
          git push || true
